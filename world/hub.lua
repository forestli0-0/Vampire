-- ============================================================================
-- HUB 世界定义
-- ============================================================================
-- 作用：定义非战斗区域（基地/飞船），提供交互点进入军械库或正式关卡。

local world = require('world.world')

local hub = {}

function hub.init(state)
    local map = {
        w = 32,
        h = 24,
        tileSize = 32,
        spawnX = 16 * 32,
        spawnY = 10 * 32
    }
    state.hubMap = map
    
    -- 初始化物理世界（和平模式）
    state.world = world.new({w = map.w, h = map.h})
    state.world.tileSize = map.tileSize
    state.world.w = map.w
    state.world.h = map.h
    state.world.pixelW = map.w * map.tileSize
    state.world.pixelH = map.h * map.tileSize
    
    -- 加载编辑器导出的最新地图数据
    local tiles = {
        69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69,
        69, 69, 69, 69, 72, 72, 72, 72, 72, 72, 72, 72, 72, 72, 72, 72, 72, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69,
        69, 69, 69, 69, 72, 72, 72, 72, 72, 72, 72, 72, 72, 72, 72, 72, 72, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69,
        69, 69, 69, 69, 72, 72, 72, 72, 72, 72, 72, 72, 72, 72, 72, 72, 72, 72, 72, 72, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69,
        69, 69, 72, 69, 69, 69, 69, 69, 18, 25, 25, 25, 25, 25, 25, 25, 25, 25, 18, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69,
        69, 69, 72, 17, 17, 17, 69, 69, 18, 16, 16, 16, 16, 16, 16, 16, 16, 16, 18, 69, 69, 17, 17, 17, 69, 69, 69, 69, 69, 69, 69, 69,
        69, 69, 69, 17, 17, 17, 69, 69, 18, 16, 10, 10, 10, 10, 10, 10, 10, 16, 18, 69, 69, 17, 17, 17, 69, 69, 69, 69, 69, 69, 69, 69,
        69, 69, 17, 17, 17, 17, 63, 63, 63, 16, 10, 10, 10, 10, 10, 10, 10, 16, 63, 63, 63, 17, 17, 17, 17, 69, 69, 69, 69, 69, 69, 69,
        69, 69, 17, 17, 17, 17, 63, 63, 63, 16, 10, 10, 10, 10, 10, 10, 10, 16, 63, 63, 63, 17, 17, 17, 17, 69, 69, 69, 69, 69, 69, 69,
        69, 69, 69, 17, 17, 17, 69, 69, 18, 16, 10, 10, 10, 10, 10, 10, 10, 16, 18, 69, 69, 17, 17, 17, 69, 69, 69, 69, 69, 69, 69, 69,
        69, 69, 69, 17, 17, 17, 69, 69, 18, 16, 10, 10, 10, 10, 10, 10, 10, 16, 18, 69, 69, 17, 17, 17, 69, 69, 69, 69, 69, 69, 69, 69,
        69, 69, 69, 69, 69, 69, 69, 69, 18, 16, 16, 16, 16, 16, 16, 16, 16, 16, 18, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69,
        69, 69, 69, 69, 69, 69, 69, 69, 18, 25, 25, 25, 25, 25, 25, 25, 25, 25, 18, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69,
        69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69,
        69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69,
        69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69,
        69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69,
        69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69,
        69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69,
        69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69,
        69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69,
        69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69,
        69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69,
        69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69,
    }
    state.world.tiles = tiles

    -- 玩家位置：中央区域 (13, 8 左右是地板区域中心)
    state.player.x = 13 * 32
    state.player.y = 8 * 32
    
    -- 定义交互点（根据新布局微调）
    state.hubInteractions = {
        { x = 11 * 32, y = 7 * 32, radius = 40, type = 'arsenal', label = "[E] 访问军械库" },
        { x = 15 * 32, y = 7 * 32, radius = 40, type = 'chapter_entry', label = "[E] 开启任务" }
    }
end

function hub.enterHub(state)
    print("DEBUG: Entering Hub")
    state.gameState = 'HUB'
    state.runMode = 'hub'
    hub.init(state)
    if state.world and state.world.tiles then
        print("DEBUG: Hub initialized. #tiles=" .. tostring(#state.world.tiles) .. " w=" .. tostring(state.world.w))
    end
    
    -- 清理战斗状态
    state.enemies = {}
    state.bullets = {}
    state.enemyBullets = {}
    state.gems = {}
    state.texts = {}
end

return hub
