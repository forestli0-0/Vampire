-- ============================================================================
-- HUB 世界定义
-- ============================================================================
-- 作用：定义非战斗区域（基地/飞船），提供交互点进入军械库或正式关卡。

local world = require('world.world')

local hub = {}

function hub.init(state)
    local map = {
        w = 32,
        h = 24,
        tileSize = 32,
        spawnX = 16 * 32,
        spawnY = 10 * 32
    }
    state.hubMap = map
    
    -- 初始化物理世界（和平模式）
    state.world = world.new({w = map.w, h = map.h})
    state.world.tileSize = map.tileSize
    state.world.w = map.w
    state.world.h = map.h
    state.world.pixelW = map.w * map.tileSize
    state.world.pixelH = map.h * map.tileSize
    
    -- 加载编辑器导出的地图数据
    local tiles = {
        69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69,
        69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69,
        69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 13, 13, 13, 13, 13, 13, 13, 13, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69,
        69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 64, 0, 0, 0, 0, 0, 0, 0, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69,
        69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 0, 0, 64, 0, 0, 0, 0, 0, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 30, 69, 69,
        69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 0, 0, 0, 0, 0, 64, 0, 0, 69, 69, 69, 69, 69, 69, 69, 69, 69, 30, 69, 69, 69,
        69, 69, 69, 69, 69, 69, 69, 13, 13, 13, 13, 0, 0, 0, 0, 0, 0, 0, 0, 13, 13, 13, 13, 69, 69, 69, 69, 69, 69, 69, 69, 69,
        69, 69, 69, 69, 69, 69, 69, 64, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 64, 10, 69, 69, 69, 69, 69, 69, 69, 69, 69,
        69, 39, 38, 67, 69, 69, 72, 0, 0, 64, 0, 0, 0, 0, 0, 0, 0, 0, 64, 0, 0, 0, 0, 62, 13, 13, 69, 69, 69, 69, 69, 69,
        69, 16, 16, 16, 13, 13, 61, 0, 0, 0, 0, 0, 0, 2, 2, 2, 2, 0, 0, 0, 0, 10, 0, 46, 47, 46, 35, 36, 34, 69, 69, 69,
        69, 2, 2, 2, 30, 33, 29, 63, 63, 63, 63, 64, 0, 2, 2, 2, 2, 63, 63, 63, 63, 63, 63, 26, 27, 28, 29, 2, 2, 69, 69, 69,
        69, 2, 2, 2, 32, 31, 33, 0, 0, 0, 0, 0, 0, 2, 2, 2, 2, 0, 0, 64, 0, 0, 10, 30, 31, 32, 32, 2, 2, 69, 69, 69,
        69, 0, 0, 0, 69, 69, 69, 0, 0, 64, 0, 0, 0, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0, 69, 69, 69, 30, 26, 26, 69, 69, 69,
        69, 69, 69, 69, 69, 69, 69, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 64, 69, 69, 69, 69, 69, 69, 69, 69, 69,
        69, 69, 69, 69, 69, 69, 69, 64, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 64, 0, 0, 0, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69,
        69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 0, 0, 64, 0, 0, 0, 0, 0, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69,
        69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 0, 0, 0, 0, 0, 0, 0, 0, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69,
        69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 0, 0, 0, 0, 0, 0, 0, 0, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69,
        69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 59, 0, 0, 0, 0, 0, 0, 59, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69,
        69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69,
        69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69,
        69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69,
        69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69, 69,
        1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
    }
    state.world.tiles = tiles

    -- 玩家位置：中央区域
    state.player.x = map.spawnX
    state.player.y = map.spawnY
    
    -- 定义交互点（根据新地图布局微调）
    state.hubInteractions = {
        { x = 3 * 32, y = 10 * 32, radius = 40, type = 'arsenal', label = "[E] 访问军械库" },
        { x = 28 * 32, y = 10 * 32, radius = 40, type = 'chapter_entry', label = "[E] 开启任务" }
    }
end

function hub.enterHub(state)
    print("DEBUG: Entering Hub")
    state.gameState = 'HUB'
    state.runMode = 'hub'
    hub.init(state)
    if state.world and state.world.tiles then
        print("DEBUG: Hub initialized. #tiles=" .. tostring(#state.world.tiles) .. " w=" .. tostring(state.world.w))
    end
    
    -- 清理战斗状态
    state.enemies = {}
    state.bullets = {}
    state.enemyBullets = {}
    state.gems = {}
    state.texts = {}
end

return hub
