# 程序化地图生成系统设计

## 核心目标

> 让玩家感觉"一直在深入推进"，而非"站着打波次"

---

## 设计原则

| 原则 | 说明 |
|------|------|
| **推进感** | 玩家从入口到出口，有明确的方向感 |
| **自然导航** | 路径不是直线，但也不迷宫，弯曲自然 |
| **空间变化** | 宽敞区域与狭窄通道交替，节奏感强 |
| **难度映射** | 空间大小 → 战斗强度 (大房间 = 硬战) |
| **喘息节点** | 商人/铁匠/休息点 作为节奏调节 |

---

## 地图结构

```
入口 ─→ [走廊] ─→ [小房间] ─→ [走廊] ─→ [大房间*] ─→ [走廊] ─→ [商人房] ─→ ... ─→ [Boss房] ─→ 出口
                                    ↓
                               [支线小房间]
```

### 核心元素

| 元素 | 尺寸 | 敌人 | 功能 |
|------|------|------|------|
| **走廊** | 窄 (2-3格宽) | 零星小怪 | 连接、喘息 |
| **小房间** | 中 (8x8~12x12) | 5-10 普通怪 | 常规战斗 |
| **大房间** | 大 (16x16+) | 15+ 怪 + 精英 | 硬战 |
| **特殊房** | 中 | 无敌人 | 商人/铁匠/神龛 |
| **Boss房** | 超大 | Boss | 章节终点 |

---

## 生成算法概念

### 第一步：生成骨架路径

```
1. 确定起点和终点 (地图两端)
2. 生成主路径 (蜿蜒的 spine)
3. 主路径上标记"节点"位置
```

### 第二步：节点扩展为房间

```
节点类型分配规则:
- 每 3-4 个战斗节点后 → 1 个休息/商人节点
- 章节末尾 → Boss 节点
- 30% 概率 → 支线房间 (可选探索)
```

### 第三步：房间尺寸 → 难度

```lua
if room.size >= 256 then  -- 16x16+
    room.difficulty = 'hard'
    room.spawnElite = true
    room.enemyCount = 15 + math.random(5)
elseif room.size >= 100 then  -- 10x10+
    room.difficulty = 'normal'
    room.enemyCount = 8 + math.random(4)
else
    room.difficulty = 'easy'
    room.enemyCount = 4 + math.random(3)
end
```

---

## 章节主题系统

| 章节 | 主题 | 视觉 | 特殊机制 |
|------|------|------|----------|
| 1 | 废弃飞船 | 金属走廊、破损舱室 | 门需要解锁 |
| 2 | 感染区 | 有机物蔓延、毒雾 | 地形伤害 |
| 3 | 虚空裂缝 | 空间扭曲、传送门 | 随机传送点 |
| 4 | Orokin遗迹 | 金色神殿、陷阱 | 激光/压板 |

---

## NPC 节点设计

### 商人 (Merchant)

- **位置**: 每章 1-2 次
- **功能**: 花费 Credits 购买道具/Mod
- **UI**: 简单商店界面

### 铁匠 (Forge)

- **位置**: 每章 0-1 次
- **功能**: 升级武器 / 融合 Mod
- **UI**: 升级选择界面

### 神龛 (Shrine)

- **位置**: 随机支线房
- **功能**: 献祭资源换取增益
- **风险**: 可能触发陷阱/额外敌人

---

## 节奏曲线

```
张力
  ▲
  │    ╱╲      ╱╲╱╲     ╱╲
  │   ╱  ╲    ╱    ╲   ╱  ╲     ╱ Boss
  │  ╱    ╲  ╱      ╲ ╱    ╲   ╱
  │ ╱      ╲╱        ╳      ╲ ╱
  │╱                         ╲
  └─────────────────────────────→ 进度
     战斗  商人  战斗  战斗  铁匠  战斗
```

**核心**: 紧张 → 释放 → 紧张 → 释放 → 高潮

---

## 实现优先级

### Phase 1: 基础骨架 (MVP)

- [ ] 线性主路径生成
- [ ] 房间节点放置
- [ ] 走廊连接
- [ ] 基础敌人分布

### Phase 2: 空间变化

- [ ] 房间尺寸随机化
- [ ] 难度映射
- [ ] 精英房逻辑

### Phase 3: 特殊节点

- [ ] 商人房
- [ ] 铁匠房
- [ ] 支线房间

### Phase 4: 章节主题

- [ ] 多套 Tileset
- [ ] 章节特殊机制
- [ ] Boss 设计

---

## 与现有系统的关系

| 现有系统 | 改造方案 |
|----------|----------|
| `world.lua` | 保留基础 tile/碰撞，重写生成算法 |
| `rooms.lua` | **废弃** 波次逻辑，改为探索逻辑 |
| `mission.lua` | 合并/重构为新的 `chapter.lua` |
| `enemies.lua` | 保留敌人定义，修改刷怪触发 |
| `director.lua` | 可能废弃，改为基于区域的刷怪 |

---

## 已确定的设计决策

### ✅ 敌人刷新机制：无感刷新

```lua
-- 刷新规则
spawn.mode = 'stealth'  -- 只在视野外刷新

function shouldSpawn(state, spawnPoint)
    local px, py = state.player.x, state.player.y
    local dx = spawnPoint.x - px
    local dy = spawnPoint.y - py
    local dist = math.sqrt(dx*dx + dy*dy)
    
    -- 必须在视野外 (屏幕半径 + 缓冲区)
    local screenRadius = 450  -- 约玩家视野范围
    local buffer = 80
    return dist > (screenRadius + buffer)
end
```

**效果**: 玩家永远不会看到敌人凭空出现，感觉像是"遭遇"而非"刷新"。

---

### ✅ 回头路：允许但引导向前

**策略**:
- ✅ 不锁门，玩家可以自由回到任何已探索区域
- ✅ 已清理房间不再刷怪（低概率刷少量巡逻怪）
- ✅ 主路径有视觉指引（灯光/箭头/地面标记）
- ✅ 小地图上标记出口方向
- ❌ 不使用强制传送门或单向门

---

### ✅ 小地图：迷雾探索

```
┌─────────────┐
│ ░░░░░░░░░░░ │  ░ = 未探索 (灰色迷雾)
│ ░░░████░░░░ │  █ = 已探索
│ ░░░█●█░░░░░ │  ● = 玩家位置
│ ░░░███░░░░░ │  ★ = 出口方向
│ ░░░░░░░★░░░ │  ◆ = 商人/特殊点
└─────────────┘
```

**功能**:
- 显示已探索区域轮廓
- 标记玩家当前位置
- 显示出口大致方向 (鼓励前进)
- 标记特殊房间图标 (商人、铁匠)

---

> [!IMPORTANT]
> 这是一个大型重构。建议先做 **Phase 1 MVP** 验证手感，再逐步添加内容。
