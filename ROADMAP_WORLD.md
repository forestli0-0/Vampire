# 大地图 / 关卡流路线图（Warframe Tileset 思路）

> 目标：从“无限刷怪”转为**任务式关卡**：地图内敌人是“遭遇/据点”，清完就安静；同时地图由**固定模块（tiles）**拼装，每次进入“眼熟但不一样”。

---

## 0) 关卡层级结构（Level Hierarchy）

游戏通关流程（Run）由以下层级组成：

1. **章节（Biome）**：视觉主题与敌人池的集合（例如：森林、工厂、虚空）。
   - 每个 Run 包含 **3 个**章节。
2. **关卡/中型地图（Stage）**：玩家当前所在的物理空间。
   - 每个章节包含 **3 个关卡**（Stage 1-1、1-2、1-3 Boss）。
   - Stage 1-1 & 1-2 是探索图；Stage 1-3 是 Boss 竞技场。
3. **区域（Sector）**：构成关卡的最小物理单元（类似 Warframe 的 Tile）。
   - 一个 Stage 由 **3~5 个**相连的 Sector 组成（例如：出生点 -> 走廊 -> 十字路口 -> 终点）。

> 术语映射（便于落到代码）：现阶段 `world.lua` 生成的“rooms/房间”更接近 **Sector**；`mission.lua` 的 `zone` 也基本等价于 Sector。未来在“Stage”层做拼装与推进，在“Biome”层切换 tileset/敌人池/氛围参数。

## 1) Warframe 的核心做法（抽象成可落地规则）

1. **Tileset（模块库）**
   - 地图不是随机雕刻出来的，而是由一套“预制房间/走廊模块”拼起来。
   - 模块内部是固定结构（美术+遮挡+地标），保证“可记忆、可读”。

2. **拼装（Graph + Connectors）**
   - 每个模块有若干连接口（门/走廊口）。
   - 运行时按规则拼成一条主线 + 若干支线（事件/奖励/精英/捷径）。
   - 变化来自：模块选择、顺序、旋转/镜像、支线数量、目标房间位置。

3. **任务/遭遇驱动的刷怪**
   - 敌人不是“计时无限刷新”，而是围绕据点/目标触发。
   - 常见形式：进入区域触发一波/几波，清完开门/给资源；或警报/事件触发增援（有上限）。

---

## 2) 我们当前代码已经具备的基础

- `world.lua`：有 tilemap（墙/地）、碰撞、以及 flow-field（BFS 距离场）供敌人绕墙追击。
- `mission.lua`：探索模式用“房间触发一次性遭遇”，不再走 `director.lua` 无限刷怪。
- 探索模式掉落已收敛：普通击杀只给 `GOLD`，精英概率掉 `pet_module_chip`；Boss 才掉 `boss_reward` 宝箱结算。

---

## 3) 下一步：把“随机雕刻房间”升级成“Tileset 拼图”

### 3.1 Tiles（模块）最小数据结构（建议）

每个 tile 模块至少包含：
- `w,h`（以 cell 计，例如 16x16 或 20x20）
- `doors`：N/E/S/W 哪些边有门（建议先用“边中心门”，降低拼装难度）
- `carve`：模块内部地形（墙体/障碍/掩体）——可以用“矩形列表”或 ASCII 图来定义
- `spawns`：推荐刷怪点（若干 cell 坐标）
- `poi`：模块内可能生成的点（商店、事件、精英、宝箱房、出口等）

实现上可先把 tiles 写在 `tilesets/*.lua` 或 `tilesets/*.txt`，后续你做像素地图也能直接转成这些模板。

### 3.2 组装算法（先做最简单也好玩）

1. 先生成主线：`START -> ... -> BOSS/EXIT`（长度控制探索时长）
2. 再从主线随机挂支线：`event/shop/elite/reward`
3. tile 旋转/镜像：让同一个模块能“换方向复用”
4. 落地到 tilemap：把每个 tile 的 carve 写入 `world.tiles`

### 3.3 任务与“非无限刷怪”的结合点

- 每个 tile/区域有 `spawnBudget`（可按难度/进度增长）
- 触发条件：进入区域、交互终端、拾取关键物、警报升级
- 结束条件：清空本区敌人 / 完成目标
- **允许“有限增援”**：例如每个区域最多补 1 次（避免后期太空）

---

## 4) 你后面做手工地图怎么接

- 手工地图本质上就是“一个大 tile 模块”或“多个模块固定拼装”。
- 依然可以复用：
  - `world.lua` 的碰撞/导航
  - `mission.lua` 的区域触发遭遇（只要给每个区域定义 bounds + spawn 点）
